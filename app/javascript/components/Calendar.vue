<template>
  <div class="calendar">
    <div class="calendar-header-area">
      <CalendarHeader
      :currentDate="currentDate"
      @prev="prevMonth"
      @next="nextMonth"
      style="background-color:#8EB8FF;height:200px;">
      </CalendarHeader>
    </div>
    <div style="min-width:100px;width:100%;border-top:5px #BAD3FF;background-color:#EEEEEE;">
      <div
        v-for="(week, index) in calendars"
        :key="index"
        style="display:flex;border-left:5px solid #BAD3FF;height:700px;"
      >
        <div
        class="calendar-date"
        v-for="(day, index) in week"
        :key="index"
        >
        <div v-if="day.month===currentMonth" style="font-weight:200;">{{day.date}}</div>
        <div v-if="day.month!==currentMonth" style="color:#D3D3D3;">{{ day.date }}</div>
        <!-- <div v-if="day.month!==currentMonth%12&&day.month%12===0" style="font-weight:200;">{{ day.date }}</div> -->
        <!-- <div v-if="day.month!==currentMonth%12&&day.month%12!==0" style="color:#D3D3D3;">{{ day.date }}</div> -->
        <draggable  v-model="devidedSchedule" group="cards" @start="drag=true" @end="drag=false" :options="options">
          <Schedule 
          :devidedSchedule="devidedSchedule"
          v-for="devidedSchedule in devidedSchedules"
          v-if="devidedSchedule.date==day.date&&devidedSchedule.month==day.month&&devidedSchedule.year==day.year"
          style="flex:1;min-height:1px;min-width:1px;max-height:100px;max-width:250px;text-align: center;margin-bottom:10px;"
          >
          </Schedule>
        </draggable>
      </div>
    </div>
  </div>
  <div>
    <button class="btn btn-primary" @click="confirmCurrentDate">CofirmCurrentDate</button>
    <button class="btn btn-primary" @click="confirmCalendar">CofirmCalendar</button>
    <button class="btn btn-primary" @click="confirmCurrentMonth">CofirmCurrentMonth</button>
  </div>
</div>
</template>

<script>
import moment from "moment";
import draggable from 'vuedraggable'

import CalendarHeader from "../components/CalendarHeader";
import Schedule from "../components/Schedule"


export default {
  name: 'Calendar',
  data() {
    return {
      // count: 0,
      options: {
        group: "myGroup",
        animation: 200
      },
      itemsB: [
         {
          title: 'hoge',
          start_yyyymmdd: moment('2020-09-07'),
          start_date: moment('2020-09-07').date(),
          end_yyyymmdd: moment('2020-09-10'),
          end_date: moment('2020-09-010').date(),
          color: '#FFD5EC',
          // icon: 0,
          commit: 'yes'
        },
      ],
      currentDate: moment().format('YYYY/MM'),
      currentMonth: moment().month()+1,
      currentYear: moment().year(),
      schedules: [
        {
          title: 'hoge',
          start_yyyymmdd: moment('2020-09-07'),
          start_date: moment('2020-09-07').date(),
          end_yyyymmdd: moment('2020-09-10'),
          end_date: moment('2020-09-010').date(),
          color: '#FFD5EC',
          // icon: 0,
          commit: 'yes'
        },
        {
          start_yyyymmdd: moment('2020-09-07'),
          start_date: moment('2020-09-07').date(),
          end_yyyymmdd: moment('2020-09-10'),
          end_date: moment('2021-09-10').date(),
          color: '#BAD3FF',
          // icon: 0,
          commit: 'no',
          title: 'fuga',
        },
        {
          title: 'yagi',
          start_yyyymmdd: moment('2020-09-07'),
          start_date: moment('2020-09-07').date(),
          end_yyyymmdd: moment('2020-09-10'),
          end_date: moment('2020-09-10').date(),
          color: '#CBFFD3',
          // icon: 0,
          commit: 'no'
        }
      ],
    };
  },
  components: {
    draggable,
    CalendarHeader,
    Schedule,
  },
  mounted: function(){
  },
  methods: {
    confirmCurrentMonth(){
      console.log(this.currentMonth);
    },
    confirmCalendar(){
      console.log(this.calendars);
    },
    confirmIconNum(){
      console.log(this.schedules[0].icon);
    },
    confirmCurrentDate(){
      console.log(this.currentDate);
    },
    createDevidedSchedules() {
      let i = 0;
      let j = 0;
      let k = 0;
      var dateArrays = [];
      var currentDates = [];
      var stopDates = [];
      while(dateArrays.length <= this.schedules.length-1){
        dateArrays.push([]);
      }
      while(i <= this.schedules.length-1){
        currentDates.push(moment(this.schedules[i].start_yyyymmdd));
        i = i + 1;
      }
      while(j <= this.schedules.length-1){
        stopDates.push(moment(this.schedules[j].end_yyyymmdd));
        j = j + 1;
      }
      
      while(k <= this.schedules.length -1){
        while (currentDates[k] <= stopDates[k]) {
          dateArrays[k].push( moment(currentDates[k]).format('YYYY-MM-DD') )
          currentDates[k] = moment(currentDates[k]).add(1, 'days');
        }
        k = k + 1; 
      }
      
      var devidedSchedules = [];
      let m = 0;
      let n = 0;
      while(m <= dateArrays.length -1){
        while(n <= dateArrays[m].length -1){
          devidedSchedules.push({
            title: this.schedules[m].title,
            color: this.schedules[m].color,
            icon: this.schedules[m].icon,
            commit: this.schedules[m].commit,
            yyyymm: moment(dateArrays[m][n]).format('YYYY/MM'),
            year: moment(dateArrays[m][n]).year(),
            month: moment(dateArrays[m][n]).month()+1,
            date: moment(dateArrays[m][n]).date(),
          });
          n = n + 1;
        }
        n = 0;
        m = m + 1;
      }

      console.log(devidedSchedules);
      return devidedSchedules;
    },
    showDevidedSchedule() {
      console.log(devidedSchedules);
    },
    getStartDate() {
      let date = moment(this.currentDate);
      const youbiNum = date.day();
      return date.subtract(youbiNum, "days");
    },
    getEndDate() {
      let date = moment(this.currentDate);
      date.endOf("month");
      const youbiNum = date.day();
      return date.add(6 - youbiNum, "days");
    },
    confirmMoment(){
      console.log(this.calendars);
      console.log(this.calendars[4][6]);
      console.log(moment(this.currentDate).endOf("month").date()-1);
    },
    getCalendar() {
      let startDate = this.getStartDate();
      const endDate = this.getEndDate();
      const weekNumber = Math.ceil(endDate.diff(startDate, "days") / 7);

      let calendars = [];
      for (let week = 0; week < 1; week++) {
        let weekRow = [];
        for (let day = 0; day < moment(this.currentMonth).daysInMonth(); day++) {
          weekRow.push({
            year: startDate.get("year"),
            month: startDate.get("month")+1,
            date: startDate.get("date")
          });
          startDate.add(1, "days");
        }
          calendars.push(weekRow);
      }

      return calendars;
      console.log(calendars);

    },
    nextMonth() {
      this.currentDate = moment(this.currentDate).add(1, "month").format('YYYY/MM');
      if(this.currentMonth <11){
        this.currentMonth++;
      }else if(this.currentMonth===11){
        this.currentMonth = 12
      }else{
        this.currentMonthReset()
      }
    },
    currentMonthReset(){
      this.currentMonth = 1
    },
    prevMonth() {
      this.currentDate = moment(this.currentDate).subtract(1, "month").format('YYYY/MM');
      
      if(this.currentMonth <=12 && this.currentMonth > 1){
        this.currentMonth--;
      }else if(this.currentMonth===1){
        this.currentMonth = 12
      }
      this.getCalendar();
    },
    // displayScheduleNum(){
    // this.calendars = []; //カレンダーパネルを初期化
    //   for (let i = 0; i < moment(this.currentMonth).daysInMonth(); i++) {
    //     //カレンダーパネルを更新
    //     let todoNumber = "-";
    //     for (let k of Object.keys(this.devidedSchedules)) {
    //       //todoListの情報をカレンダーパネルに追加
    //       if (this.calendars[i]) {
    //         if (this.devidedSchedules[k].date === this.calendars[i].date) {
    //           todoNumber++;
    //         }
    //       }
    //     }
    //     this.calendars[i] = {
    //       date: moment(this.currentMonth)
    //         .startOf("month")
    //         .add(i, "day")
    //         .format("YYYY-MM-DD"),
    //       dateNumber: i + 1,
    //       todoNumber: todoNumber
    //     };
    // }
  },
  computed: {
    calendars() {
      return this.getCalendar();
    },
    devidedSchedules() {
      return this.createDevidedSchedules();
    },
    currentMonth(){
      return currentMonth();
    }
  },
  created(){
    console.log(currentDate);
    return this.createDevidedSchedules();
    // this.displayScheduleNum();
  },
  // watch:{
  //   displayScheduleNum(){
      
  //   }
  //   this.calendars = []; //カレンダーパネルを初期化
  //     for (let i = 0; i < moment(this.currentMonth).daysInMonth(); i++) {
  //       //カレンダーパネルを更新
  //       let todoNumber = "-";
  //       for (let k of Object.keys(this.devidedSchedules)) {
  //         //todoListの情報をカレンダーパネルに追加
  //         if (this.calendars[i]) {
  //           if (this.devidedSchedules[k].date === this.calendars[i].date) {
  //             todoNumber++;
  //           }
  //         }
  //       }
  //       this.calendars[i] = {
  //         date: moment(this.currentMonth)
  //           .startOf("month")
  //           .add(i, "day")
  //           .format("YYYY-MM-DD"),
  //         dateNumber: i + 1,
  //         todoNumber: todoNumber
  //       };
  //     }
  // }
}
</script>

<style scoped>
.calendar {
  margin-top:3%;
  margin-left: 10%;
  margin-right: 0.5%;
  /* position: fixed; */
  width:125%;
  /* z-index:1; */
  display: flex;
  flex-direction: column;
}

.calendar-header-area {
  height:200px;
}

.calendar-date{
  flex:1;
  min-height:125px;
  border-right:5px solid #BAD3FF;
  border-bottom:5px solid #BAD3FF;
  text-align: center;
  font-size:25px;
}

.calendar-date:hover {
  background-color: silver;
  border-radius: 4px;
}

</style>
